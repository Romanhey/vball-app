version: "3.9"

services:
  postgres:
    image: postgres:latest
    container_name: vball-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres21
      POSTGRES_PASSWORD: "123"
      POSTGRES_DB: schedule_db
    volumes:
      - postgres_data:/var/lib/postgresql/
    ports:
      - "5432:5432"
    networks:
      - vball

  identity:
    container_name: vball-identity
    build:
      context: ./VBALL.Identity
      dockerfile: ./Identity.Presentation/Dockerfile
    depends_on:
      - postgres
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:5000
      ConnectionStrings__DefaultConnection: >
        Host=postgres;
        Port=5432;
        Database=identity_db;
        Username=postgres21;
        Password=123;
        Include Error Detail=true
      JwtSettings__Secret: AoehmeHJpmeoMNepmpcwqz&Lnd#%68ajndaNAoehmeHJpmeoMNepmpcwqz&Lnd#%68ajndaN
      JwtSettings__Issuer: Vball_app_server
      JwtSettings__Audience: Vball_app_client
    ports:
      - "5000:5000"
    networks:
      - vball

  schedule:
    container_name: vball-schedule
    build:
      context: ./VBALL.Schedule
      dockerfile: ./Schedule.Presentation/Dockerfile
    depends_on:
      - postgres
      - notifications
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://0.0.0.0:5054
      ConnectionStrings__DefaultConnection: >
        Host=postgres;
        Port=5432;
        Database=schedule_db;
        Username=postgres21;
        Password=123;
        Include Error Detail=true
    ports:
      - "5054:5054"
    networks:
      - vball

  notifications:
    container_name: vball-notifications
    build:
      context: ./VBALL.Notifications
      dockerfile: ./Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: default
      SERVER_PORT: 8080
      GRPC_SERVER_PORT: 9090
    ports:
      - "8080:8080"
      - "9090:9090"
    networks:
      - vball

  client-build:
    container_name: vball-client-build
    build:
      context: ./VBALL.Client
      dockerfile: ./Dockerfile
    volumes:
      - client_static:/static
    networks:
      - vball
    profiles:
      - build
    command: >
      sh -c "echo 'Copying build files...' &&
             rm -rf /static/* &&
             cp -r /build-output/* /static/ &&
             tail -f /dev/null"

  nginx:
    container_name: vball-nginx
    build:
      context: ./nginx
      dockerfile: ./Dockerfile
    depends_on:
      - identity
      - schedule
    ports:
      - "80:80"
    volumes:
      - client_static:/usr/share/nginx/html:ro
    networks:
      - vball
    restart: unless-stopped

networks:
  vball:
    driver: bridge

volumes:
  postgres_data:
  client_static:
