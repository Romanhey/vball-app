# Бизнес-логика системы записи игроков на волейбольные матчи

## 1. Цель системы

Записать игрока на матч и зафиксировать данные о прошедшем матче.

---

## 2. Роли

- **Игрок** (пользователь) - подает заявки, подтверждает участие
- **Администратор** - управляет заявками, распределяет по командам, вводит результаты

---

## 3. Основные сущности

### User (внешний сервис Identity)

- Имя, контактные данные
- Получается через RPC-вызов по PlayerId

### Match

- Дата и время проведения (StartTime)
- Статус (MatchStatus): Scheduled → InProgress → Finished
- Две команды (TeamAId, TeamBId) - назначаются администратором при создании матча
- Финальный счет (FinalScore) - формат "3:1" (счет по партиям), вводится после завершения
- **Важно:** Время матча НЕ может быть изменено после создания (по регламенту лиги)

### Participation

- Связывает игрока (PlayerId) с матчем (MatchId)
- Назначенная команда (TeamId) - заполняется при подтверждении участия
- Статус (ParticipationStatus)
- Дата создания (CreatedAt) и обновления (UpdatedAt)
- Причина отмены (CancellationReason) - опционально
- Тип отмены (CancellationType) - для разделения обычных отмен и форс-мажоров
  для будущих обновлений:
- ID замещающего игрока (ReplacedBy) - если статус Cancelled с типом Emergency
- Признак экстренной замены (IsEmergencyReplacement) - true, если создан админом в обход обычного flow
- ID заменяемой заявки (ReplacesParticipationId) - ссылка на заявку, которую заменяет эта
- ID создавшего администратора (CreatedByAdminId) - для emergency-замен

### Team

- Название команды (Name)
- Рейтинг команды (Rating)
- Рейтинг игроков НЕ учитывается

### ParticipationStatus (цепочка статусов)

```
Applied → Reviewed → Registered → Confirmed → [Cancelled]
            ↓            ↓
        Waitlisted  Подтверждение
            ↓        за 24ч
        Reviewed
            ↓
        Registered
```

### CancellationType (тип отмены)

```csharp
public enum CancellationType
{
    PlayerRequest,      // Игрок сам отменил (через PendingCancellation)
    AdminDecision,      // Администратор исключил игрока
    NoConfirmation,     // Игрок не подтвердил участие вовремя
    Emergency          // Форс-мажор (травма, болезнь, ДТП и т.п.)
}
```

### MatchStatus

```
Scheduled → InProgress → Finished
```

---

## 4. Бизнес-правила состава

### Количество игроков

- На матч должно быть **ровно 14 игроков**
- В каждой команде должно быть **по 7 игроков**
- Минимальное и максимальное количество одинаково — 14
- Превышение лимита невозможно - игроки попадают в лист ожидания

### Распределение по командам

- Распределение выполняет **администратор вручную**
- Автораспределение отсутствует
- Команда назначается игроку при переходе в статус **Confirmed** (заполняется поле `TeamId` в `Participation`)

### Сроки формирования состава

- Состав должен быть полностью сформирован **не позднее чем за 24 часа до начала матча**
- За 24 часа до матча начинается процесс подтверждения участия
- При подтверждении участия participationStatus → Confirmed

---

## 5. Жизненный цикл заявки игрока

### 5.1 Подача заявки

**Действие:** Игрок подает заявку на участие в матче

**Ограничения:**

- Заявку можно подать только если **до начала матча > 24 часов**
- При попытке подать заявку позже → ошибка валидации: "Заявки принимаются не позднее чем за 24 часа до начала матча"
- Игрок может иметь только **ОДНУ активную заявку** на матч (активная = любой статус кроме Cancelled)
- При попытке подать повторную заявку → ошибка валидации

**Результат:**

- Создается запись `Participation` со статусом **Applied**
- Если на матч уже 14 заявок в статусах Applied/Reviewed/Registered → автоматический переход в **Waitlisted**

### 5.2 Просмотр заявки администратором

**Действие:** Администратор просматривает заявку и одобряет её

**Переход:** Applied → **Reviewed**

**Бизнес-смысл:**

- Игрок получает обратную связь: "Ваша заявка рассмотрена"
- Администратор просматривает все заявки вручную
- Reviewed НЕ гарантирует попадание в основной состав

**Условия:**

- Можно перевести в Reviewed даже если уже 14 человек в Registered
- Reviewed - это промежуточный статус для всех заявок

**Автоматика при переполнении:**

- Если в момент перевода Applied → Reviewed уже 14 игроков в Registered → автоматический переход Applied → **Waitlisted** (минуя Reviewed)

### 5.3 Регистрация (включение в основной состав)

**Переход:** Reviewed → **Registered**

**Действие:** Администратор **вручную** включает игрока в список 14 участников

**Условия:**

- В статусах Registered/Confirmed должно быть < 14 игроков
- Команда ещё НЕ назначена (`TeamId = null`)
- До начала матча > 24 часов

**Результат:**

- Игрок включен в основной состав матча
- Ожидает процесса подтверждения за 24 часа до матча

### 5.4 Подтверждение участия (за 24 часа до матча)

**Действие:** За 24 часа до начала матча игрок должен подтвердить своё участие

**Переход:** Registered → **Confirmed**

**Процесс:**

- Система за 24 часа до матча отправляет уведомление игрокам в статусе Registered
- Игрок должен подтвердить участие **до конца дня, который идет до матча (до 22:59)**
  - Пример: Матч в субботу в 10:00 → подтвердить нужно до пятницы 22:59
- При подтверждении:
  - Статус → Confirmed
  - Администратор назначает команду (заполняется `Participation.TeamId`)

**Неподтверждение:**

- Если игрок не подтвердил до дедлайна → автоматический переход в статус **Cancelled**
- CancellationType = NoConfirmation
- Место освобождается для игрока из листа ожидания

### 5.5 Лист ожидания (Waitlisted)

**Попадание в лист:**

- Автоматически, если на момент подачи/рассмотрения заявки уже 14 участников в Registered/Confirmed
- Прямой переход: Applied → Waitlisted (минуя Reviewed, если список полон)

**Выход из листа:**

- Администратор **вручную** переводит: Waitlisted → Reviewed → Registered (когда освободилось место)
- При отмене чьего-либо участия администратор выбирает игрока из листа ожидания

### 5.6 Отмена участия

#### Отмена игроком

**Условия:**

- Возможна для любого статуса до Confirmed
- Матчи **платные**, поэтому требуется одобрение администратора

**Процесс:**

- Игрок отправляет запрос на отмену → статус **PendingCancellation**
- Администратор рассматривает и подтверждает → статус **Cancelled**
- CancellationType = PlayerRequest
- Причина отмены сохраняется в `CancellationReason`

**Возможность отмены:**

- Статусы Applied, Reviewed, Waitlisted: отмена возможна
- Статус Registered: отмена возможна (через PendingCancellation)
- Статус Confirmed: отмена **игроком запрещена** (только администратор)

#### Отмена администратором

- Администратор может отменить участие игрока **в любой момент** до завершения матча
- Прямой переход в статус **Cancelled** (минуя PendingCancellation)
- Обязательно указание:
  - CancellationType (AdminDecision или Emergency)
  - CancellationReason

#### Последствия отмены

- Обычная отмена (PlayerRequest, AdminDecision) может влиять на репутацию игрока
- Emergency отмена **НЕ влияет** на репутацию и статистику надежности игрока
- Отмена участия **НЕ влияет** на возможность подавать заявки на будущие матчи
- Место освобождается для игрока из листа ожидания

### 5.7 Экстренные ситуации (Emergency)

**Когда применяется:**

- Травма непосредственно перед матчем или во время него
- Внезапное недомогание, болезнь
- ДТП, форс-мажор
- Любая объективная причина, когда игрок не может участвовать

**Процесс экстренной замены:**

1. **Отмена игрока:**

   - Администратор переводит: Confirmed → Cancelled
   - CancellationType = **Emergency**
   - Обязательно указывается CancellationReason (описание ситуации)
   - Фиксируется ReplacedBy (ID замещающего игрока, если есть)

2. **Добавление замены (опционально):**

   - Администратор создает **новую заявку** для замещающего игрока
   - Статус сразу **Confirmed** (минуя обычную цепочку Applied → Reviewed → Registered)
   - TeamId = тот же, что был у заменяемого игрока
   - IsEmergencyReplacement = true
   - ReplacesParticipationId = ID заявки заменяемого игрока
   - CreatedByAdminId = ID администратора

3. **Связь между заявками:**
   - У заменяемого: ReplacedBy = PlayerId замещающего
   - У замещающего: ReplacesParticipationId = ParticipationId заменяемого

**Влияние на статистику:**

- Emergency отмены **НЕ считаются** как обычные отмены в статистике надежности игрока
- В отчетах матча видно: "Игрок A (Emergency: травма) → Игрок B"
- Замещающий игрок учитывается в статистике матча как обычный участник

**Ограничения:**

- Emergency применяется только для статуса Confirmed
- Только администратор может создавать экстренные замены
- После завершения матча (Finished) изменения запрещены

---

## 6. Управление статусами Participation

### Разрешенные переходы

```
Applied → Reviewed → Registered → Confirmed
   ↓         ↓
Waitlisted   ↓
   ↓      (если 14 мест заняты)
Reviewed
   ↓
Registered

Отмены:
Applied/Reviewed/Waitlisted → PendingCancellation → Cancelled (игрок)
Registered → PendingCancellation → Cancelled (игрок)
Confirmed → Cancelled (только администратор)

Любой статус → Cancelled (администратор напрямую, с указанием CancellationType)
```

### Запрещенные действия

- Перескоки через статусы (например, Applied → Registered)
- Возврат из Cancelled в активные статусы
- Изменение статуса после завершения матча (Match.Status = Finished)
- Отмена игроком из статуса Confirmed

### Обработка заявок при начале матча

**Действие:** При переходе Match.Status: Scheduled → InProgress

**Результат:**

- Все заявки в статусах Applied/Reviewed/Waitlisted → автоматически **Cancelled**
- CancellationType = AdminDecision
- CancellationReason = "Матч начался"
- Альтернатива: можно удалять такие заявки полностью (на усмотрение реализации)

---

## 7. Жизненный цикл матча

### 7.1 Создание матча

**Действие:** Администратор создает матч

**Данные:**

- Дата и время проведения (StartTime)
- Две команды (TeamAId, TeamBId) - выбираются из существующих команд
- Статус: **Scheduled**

**Ограничения:**

- StartTime должен быть в будущем
- Время матча **НЕ может быть изменено** после создания (по регламенту лиги)

### 7.2 Проведение матча

**Переход:** Scheduled → **InProgress**

**Условия:**

- Состав полностью сформирован (14 игроков в статусе Confirmed)
- Игроки распределены по командам (по 7 в каждой)

**Процесс:**

- Администратор вручную переводит статус
- При переходе: все заявки не в Confirmed → Cancelled или удаляются
- В будущем: можно добавить таблицу SetScore для ввода счета по партиям в реальном времени

### 7.3 Завершение матча

**Переход:** InProgress → **Finished**

**Обязательное действие:**

- Администратор вводит финальный счет в формате "3:1" (количество выигранных партий)
- Счет сохраняется в поле `Match.FinalScore`

**Правила:**

- Матч считается завершенным **только после ввода финального счета**
- После завершения матча можно редактировать **только данные самого матча** (например, FinalScore)
- Изменение статусов Participation после завершения матча **запрещено**

### 7.4 Особенности

- Матч **не может быть отменён** (только завершён)
- Рейтинг имеет только команда (`Team.Rating`)
- Рейтинг игроков не учитывается
- В будущем: расчет статистики игроков (PlayerStatistics) и детальный счет (SetScore)

---

## 8. Уведомления (интеграция с Notification Service)

### Типы уведомлений

- **MatchReminder** - за 24 часа до матча (игрокам в статусе Registered)
- **ParticipationStatusChanged** - при изменении статуса заявки
- **TeamAssigned** - когда администратор назначил команду
- **ParticipationCancelled** - когда администратор отменил чье-то участие
- **MatchFinished** - после завершения матча с результатами
- **CancellationRequestReceived** - администратору о новом запросе на отмену (PendingCancellation)

---

## 9. Будущие расширения

### Планируется добавить:

1. **SetScore** - детальный счет по партиям (25:23, 25:20, 23:25)
2. **PlayerStatistics** - статистика игрока в матче (эйсы, блоки, атаки, ошибки, очки)
3. **Tournament** - турниры и сезоны
4. **TournamentStanding** - турнирная таблица

---

## 10. Технические ограничения

- User получается из внешнего Identity Service через RPC
- Место проведения (venue) не используется - всегда одно и то же
- Локальная проекция Player не требуется
- База данных: отдельная для Schedule Service и Notification Service

---

## 11. Ключевые изменения относительно v2

1. ✅ Убран статус Created - заявки начинаются сразу с Applied
2. ✅ Добавлен запрет на подачу заявок менее чем за 24 часа до матча
3. ✅ Добавлен enum CancellationType для типизации отмен
4. ✅ Уточнена логика переходов Reviewed → Registered (вручную администратором)
5. ✅ Добавлен переход Waitlisted → Reviewed → Registered
6. ✅ Сохранен PendingCancellation (матчи платные, требуется одобрение)
7. ✅ Уточнен дедлайн подтверждения: до 22:59 дня, который идет до матча
8. ✅ Добавлено правило автоотмены/удаления заявок при начале матча
9. ✅ Добавлено правило: одна активная заявка на матч
10. ✅ Зафиксировано: время матча не может быть изменено
11. ✅ Добавлены поля для поддержки экстренных замен (Emergency)
12. ✅ Добавлено правило: после завершения матча можно редактировать только данные самого матча

**Конец документа.**
