# Бизнес-логика системы записи игроков на волейбольные матчи

## 1. Цель системы

Записать игрока на матч и зафиксировать данные о прошедшем матче.

---

## 2. Роли

- **Игрок** (пользователь) - подает заявки, подтверждает участие
- **Администратор** - управляет заявками, распределяет по командам, вводит результаты

---

## 3. Основные сущности

### User (внешний сервис Identity)

- Имя, контактные данные
- Получается через RPC-вызов по PlayerId

### Match

- Дата и время проведения (StartTime)
- Статус (MatchStatus): Scheduled → InProgress → Finished
- Две команды (TeamAId, TeamBId) - назначаются администратором при создании матча
- Финальный счет (FinalScore) - формат "3:1" (счет по партиям), вводится после завершения

### Participation

- Связывает игрока (PlayerId) с матчем (MatchId)
- Назначенная команда (TeamId) - заполняется при подтверждении участия
- Статус (ParticipationStatus)
- Дата создания (CreatedAt) и обновления (UpdatedAt)
- Причина отмены (CancellationReason) - опционально

### Team

- Название команды (Name)
- Рейтинг команды (Rating)
- Рейтинг игроков НЕ учитывается

### ParticipationStatus (цепочка статусов)

```

Created -> Applied → Reviewed → Registered → Confirmed → [Cancelled]
              ↓
          Waitlisted (если мест нет)
              ↓
    PendingCancellation (запрос на отмену)
```

### MatchStatus

```
Scheduled → InProgress → Finished
```

---

## 4. Бизнес-правила состава

### Количество игроков

- На матч должно быть **ровно 14 игроков**
- В каждой команде должно быть **по 7 игроков**
- Минимальное и максимальное количество одинаково — 14
- Превышение лимита невозможно - игроки попадают в лист ожидания

### Распределение по командам

- Распределение выполняет **администратор вручную**
- Автораспределение отсутствует
- Команда назначается игроку при переходе в статус **Confirmed** (заполняется поле `TeamId` в `Participation`)

### Сроки формирования состава

- Состав должен быть полностью сформирован **не позднее чем за 24 часа до начала матча**
- За 24 часа до матча начинается процесс подтверждения участия
- При подтверждении участия participationStatus - confirmed

---

## 5. Жизненный цикл заявки игрока

### 5.1 Подача заявки

**Действие:** Игрок подает заявку на участие в матче

**Результат:**

- Создается запись `Participation` со статусом **Created**
- При отправке заявка переходит в статус **Applied**
- Если на матч уже 14 заявок в статусе Created/Applied/Reviewed/Registered → автоматический переход в **Waitlisted**

### 5.2 Просмотр заявки администратором

**Действие:** Администратор просматривает заявку и одобряет её

**Переход:** Applied → **Reviewed**

**Условия:**

- Заявка может быть одобрена только если есть свободные места (< 14 игроков в статусах Registered)
- Если мест нет - заявка переходит в Waitlisted

### 5.3 Регистрация (включение в основной состав)

**Переход:** Reviewed → **Registered**

**Условия:**

- Игрок включен в список 14 участников матча
- Команда ещё НЕ назначена (`TeamId = null`)
- До начала матча > 24 часов

**Автоматика:**

- Статус меняется автоматически после одобрения администратором, если есть места

### 5.4 Подтверждение участия (за 24 часа до матча)

**Действие:** За 24 часа до начала матча игрок должен подтвердить своё участие

**Переход:** Registered → **Confirmed**

**Процесс:**

- Система за 24 часа до матча отправляет уведомление игрокам в статусе Registered
- Игрок должен подтвердить участие до конца дня (до 23:59:59)
- При подтверждении:
  - Статус → Confirmed
  - Администратор назначает команду (заполняется `Participation.TeamId`)

**Неподтверждение:**

- Если игрок не подтвердил до конца дня → автоматический переход в статус **Cancelled**
- Место освобождается для игрока из листа ожидания

### 5.5 Лист ожидания (Waitlisted)

**Попадание в лист:**

- Автоматически, если на момент подачи/одобрения заявки уже 14 участников

**Выход из листа:**

- Администратор вручную переводит игрока из Waitlisted → Reviewed (если освободилось место)
- При отмене чьего-либо участия администратор может выбрать игрока из листа ожидания

### 5.6 Отмена участия

#### Отмена игроком

**Условия:**

- Возможна вплоть до момента за 24 часа до начала матча
- После начала процесса подтверждения (статус Registered/Confirmed) отмена игроком запрещена

**Процесс:**

- Игрок отправляет запрос на отмену → статус **PendingCancellation**
- Администратор рассматривает и подтверждает → статус **Cancelled**
- Причина отмены сохраняется в `CancellationReason`

#### Отмена администратором

- Администратор может отменить участие игрока **в любой момент** до завершения матча
- Прямой переход в статус **Cancelled**
- Обязательно указание причины в `CancellationReason`

#### Последствия отмены

- Отмена участия **НЕ влияет** на возможность подавать заявки на будущие матчи
- Место освобождается для игрока из листа ожидания

---

## 6. Управление статусами Participation

### Разрешенные переходы

```
Created → Applied → Reviewed → Registered → Confirmed
            ↓
        Waitlisted → Reviewed (вручную администратором)

Из любого статуса (кроме Cancelled) → PendingCancellation → Cancelled
Из любого статуса → Cancelled (администратором напрямую)
```

### Запрещенные действия

- Перескоки через статусы (например, Applied → Confirmed)
- Возврат из Cancelled в активные статусы
- Изменение статуса после завершения матча

---

## 7. Жизненный цикл матча

### 7.1 Создание матча

**Действие:** Администратор создает матч

**Данные:**

- Дата и время проведения (StartTime)
- Две команды (TeamAId, TeamBId) - выбираются из существующих команд
- Статус: **Scheduled**

### 7.2 Проведение матча

**Переход:** Scheduled → **InProgress**

**Условия:**

- Состав полностью сформирован (14 игроков в статусе Confirmed)
- Игроки распределены по командам (по 7 в каждой)

**Процесс:**

- Администратор вручную переводит статус
- В будущем: можно добавить таблицу SetScore для ввода счета по партиям в реальном времени

### 7.3 Завершение матча

**Переход:** InProgress → **Finished**

**Обязательное действие:**

- Администратор вводит финальный счет в формате "3:1" (количество выигранных партий)
- Счет сохраняется в поле `Match.FinalScore`

**Правила:**

- Матч считается завершенным **только после ввода финального счета**
- После сохранения счет **не подлежит редактированию**
- Отмена матча не предусмотрена

### 7.4 Особенности

- Матч **не может быть отменён** (только завершён)
- Рейтинг имеет только команда (`Team.Rating`)
- Рейтинг игроков не учитывается
- В будущем: расчет статистики игроков (PlayerStatistics) и детальный счет (SetScore)

---

## 8. Уведомления (интеграция с Notification Service)

### Типы уведомлений

- **MatchReminder** - за 24 часа до матча (игрокам в статусе Registered)
- **ParticipationStatusChanged** - при изменении статуса заявки
- **TeamAssigned** - когда администратор назначил команду
- **MatchCancelled** - если администратор отменил чье-то участие
- **MatchFinished** - после завершения матча с результатами

---

## 9. Будущие расширения

### Планируется добавить:

1. **SetScore** - детальный счет по партиям (25:23, 25:20, 23:25)
2. **PlayerStatistics** - статистика игрока в матче (эйсы, блоки, атаки, ошибки, очки)
3. **Tournament** - турниры и сезоны
4. **TournamentStanding** - турнирная таблица

---

## 10. Технические ограничения

- User получается из внешнего Identity Service через RPC
- Место проведения (venue) не используется - всегда одно и то же
- Локальная проекция Player не требуется
- База данных: отдельная для Schedule Service и Notification Service

**Конец документа.**
